# <center>后端非线性优化</center>

这是一个基于滑窗的紧耦合VIO。![1561038125697](/home/max/.config/Typora/typora-user-images/1561038125697.png)







## 1.状态向量

在滑窗内的所有状态向量包括$n+1$个IMU状态和相机到IMU的外参以及$m+1$个特征点的逆深度。其中每个IMU状态包括IMU在世界坐标系中的位置，速度，方向，在IMU坐标系中的加速度bias，陀螺仪bias。
$$
\mathcal{X}=[x_0, x_1,\ldots,x_n,x^b_c,\lambda_1,\lambda_2,\ldots,\lambda_m]
$$

$$
x_k=[p^w_{b_k},v^w_{b_k},q^w_{b_k},b_a,b_g]
$$

$$
x^b_c=[p^b_c,q^b_c] \tag{1}
$$



这里$\lambda_l$是第$l$个特征点第一次被观测到的逆深度。

## 2.目标函数

最小化先验信息和所有测量参差的和，从而得到一个最大后验估计：
$$
\min_\mathcal{X}\{\parallel{r_p-H_p\mathcal{X}\parallel^2+\sum_{k\in\mathcal{B}}\parallel{r_\mathcal{B}(\hat{z}^{b_k}_{b_{k+1}},\mathcal{X})}\parallel^2_{p^{b_k}_{b_{k+1}}}+\sum_{(l,j)}\rho(\parallel{r_\mathcal{C}(\hat{z}^{c_j}_l,\mathcal{X})}\parallel^2_{p^{c_j}_l})}\} \tag{2}
$$
其中Huber算子定义如下：
$$
\rho(s)=\begin{cases}
1,\quad s\geq 1\\
2\sqrt{s}-1, \quad s<1
\end{cases}
\tag{3}
$$

$r_\mathcal{B}(\hat{z}^{b_k}_{b_{k+1}},\mathcal{X})$,$r_\mathcal{C}(\hat{z}^{c_j}_l,\mathcal{X})$分别对应IMU和视觉的测量残差。$\mathcal{B}$是所有IMU测量的集合，$\mathcal{C}$是在当前滑窗中至少被观测到一次的所有特征点的集合。$\{r_p, \mathcal{H}_p\}$是来自边缘化的先验信息。3种残差都是用马氏距离表示。

根据《SLAM中的优化理论》，定义目标函数为：
$$
f(\mathcal{X})=\frac{1}{2}r^T_i(\mathcal{X})r_i(\mathcal{X}) \tag{4}
$$
雅各比矩阵$J(\mathcal{X})$:
$$
J_{i,j}(\mathcal{X})=[\frac{\partial{r_i(\mathcal{X})}}{\partial{x_j}}] \tag{5}
$$
假设目标函数$f$是平滑的，我们可以对其进行泰勒展开：
$$
f(\mathcal{X+\triangle{\mathcal{X}}})=f(\mathcal{X})+\triangle{\mathcal{X}}^Tg(\mathcal{X})+\frac{1}{2}\triangle{\mathcal{X}}^T\mathcal{H}(\mathcal{X})\triangle{\mathcal{X}}+\mathcal{O}(\parallel{\triangle{\mathcal{X}}}\parallel^3) \tag{6}
$$
其中$g(\mathcal{X})$,$\mathcal{H}(\mathcal{X})$分别对应目标函数的梯度和海森矩阵：
$$
g(\mathcal{X})=J^T(\mathcal{X})r(\mathcal{X}) \tag{7}
$$

$$
\mathcal{H}(\mathcal{X})=J^T(\mathcal{X})J(\mathcal{X}) \tag{8}
$$

高斯牛顿法是一种高效的方法，它是一种基于一阶导数推导而来的。在某些情况下，具有平方收敛的效果。高斯牛顿方法工作的基础是在工作点$\mathcal{X}$附近邻域线性化：
$$
r(\mathcal{X}+\triangle{\mathcal{X}})=r(\mathcal{X})+J(\mathcal{X})r(\mathcal{X}) \tag{9}
$$
由于要使得目标函数有极小值，目标函数的一阶导数应该为0，由此可以得出高斯牛顿法的正则方程或者叫做增量方程：
$$
J^T(\mathcal{X})J(\mathcal{X})\triangle{\mathcal{X}}=-J(\mathcal{X})r(\mathcal{X}) \tag{10}
$$
通过增量方程可以知道优化算法下一步的迭代如何进行。

对当前目标函数(2)而言，整体的增量方程可以写成：
$$
(H_p+\sum{{J^{b_k}_{b_{k+1}}}^T{P^{b_k}_{b_{k+1}}}^{-1}}{J^{b_k}_{b_{k+1}}}+\sum{{J^{C_j}_l}^T{P^{C_j}_l}^{-1}}{J^{C_j}_l})\triangle{\mathcal{X}}
$$

$$
=b_p+\sum{{J^{b_k}_{b_{k+1}}}^T{P^{b_k}_{b_{k+1}}}^{-1}}r_B+\sum{{J^{C_j}_l}^T{P^{C_j}_l}^{-1}}r_C \tag{11}
$$



其中$P^{b_k}_{b_{k+1}}$，$P^{C_j}_l$分别为IMU预积分噪声项的协方差和视觉观测的噪声协方差。协方差越大，意味着观测越不稳定。

注意，上面的雅各比矩阵虽然是误差项对状态向量的一阶导数。但在具体求解时，通常采用扰动的方式$\delta{\mathcal{X}}$计算，而不是增量$\triangle{\mathcal{X}}$:
$$
J(\mathcal{X})=\frac{\partial{r}}{\partial{\mathcal{X}}}=\lim_{\delta{\mathcal{X}}\rightarrow0} \frac{r(\mathcal{X}\oplus \delta{\mathcal{X}})-r(\mathcal{X})}{\delta \mathcal{X}} \tag{12}
$$

## 3.IMU约束

### 3.1 残差

根据《IMU预积分》中IMU预积分模型公式（18）可以定义连续两帧IMU之间预积分的测量残差为：
$$
r_\mathcal{B}^{15\times1}(\hat{z}^{b_k}_{b_{k+1}},\mathcal{X})=
\left |
\begin{matrix}
\delta{\alpha^{b_k}_{b_{k+1}}} \\
\delta{\theta^{b_k}_{b_{k+1}}} \\
\delta{\beta^{b_k}_{b_{k+1}}} \\
\delta{b_a} \\
\delta{b_g}
\end{matrix}
\right | =
\left |
\begin{matrix}
R^{b_k}_w (p^w_{b_{k+1}}-p^w_{b_k}-v^w_{b_k}\triangle{t_k}+\frac{1}{2}g^w\triangle{t_k^2})-\alpha^{b_k}_{b_{k+1}}\\
2[{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes({q^w_{b_k}}^{-1}\otimes q^w_{b_{k+1}})]_{xyz} \\
R^{b_k}_w(v^w_{b_{k+1}}-v^w_{b_k}+g^w\triangle{t_k})-\beta^{b_k}_{b_{k+1}} \\
b_{a_{b_{k+1}}}-b_{a_{k}} \\
b_{w_{b_{k+1}}}-b_{w_{k}}
\end{matrix}
\right | \tag{13}
$$
其中$[]_{xyz}$表示四元数的向量部分，即可表示方向的误差，当然向量空间的方向变化是四元数方向变化角度的2倍。具体可参考《四元数数学基础》2.4.6节。

### 3.2 优化变量

$$
[p^w_{b_k},q^w_{b_k}],[v^w_{b_k},b_{a_k},b_{w_k}],[p^w_{b_{k+1}},q^w_{b_{k+1}}],[v^w_{b_{k+1}},b_{a_{k+1}},b_{w_{k+1}}]
$$

### 3.3 雅各比

#### 3.3.1 残差关于$[p^w_{b_k},q^w_{b_k}]$的雅各比

$$
J[0]^{15\times7}=[\frac{\partial{r_\mathcal{B}}}{\partial{p^w_{b_k}}},\frac{\partial{r_\mathcal{B}}}{\partial{q^w_{b_k}}}]=
\left |
\begin{matrix}
-R^{b_k}_w & [R^{b_k}_w (p^w_{b_{k+1}}-p^w_{b_k}-v^w_{b_k}\triangle{t_k}+\frac{1}{2}g^w\triangle{t_k^2})]_\times \\
0          & -{\mathcal{L}[{q^w_{b_{k+1}}}^{-1} \otimes q^w_{b_k}]
              \mathcal{R}[\gamma^{b_k}_{b_{k+1}}}] \\
0          & [R^{b_k}_w(v^w_{b_{k+1}}-v^w_{b_k}+g^w\triangle{t_k})]_\times \\
0          & 0 \\
0          & 0
\end{matrix}
\right | \tag{14}
$$



其中$\frac{\partial{r_\mathcal{B}}}{\partial{q^w_{b_k}}}$第一行和第三行推导完全一样，都是旋转矩阵乘上向量对四元数求导，这里推导第三行：
$$
\frac{\partial{\delta{\beta}^{b_k}_{b_{k+1}}}}{\partial{q^w_{b_k}}}=\lim_{\delta{\theta^w_{b_k}} \rightarrow 0} \frac{(R^w_{b_k}\exp([\delta{\theta^w_{b_k}}]_\times))^{-1}(v^w_{b_{k+1}}-v^w_{b_k}+g^w\triangle{t_k})-R^{b_k}_w(v^w_{b_{k+1}}-v^w_{b_k}+g^w\triangle{t_k})}{\delta{\theta^w_{b_k}}}
$$

$$
=\lim_{\delta{\theta^w_{b_k}} \rightarrow 0} \frac{(I-[\delta{\theta^w_{b_k}}]_\times)R^{b_k}_w(v^w_{b_{k+1}}-v^w_{b_k}+g^w\triangle{t_k})}{\delta{\theta^w_{b_k}}}
$$

$$
=\lim_{\delta{\theta^w_{b_k}} \rightarrow 0} \frac{-[\delta{\theta^w_{b_k}}]_\times R^{b_k}_w(v^w_{b_{k+1}}-v^w_{b_k}+g^w\triangle{t_k})}{\delta{\theta^w_{b_k}}}
$$

根据向量性质$[a]_\times b=-[b]_\times a$可得：
$$
=\lim_{\delta{\theta^w_{b_k}} \rightarrow 0} \frac{[R^{b_k}_w(v^w_{b_{k+1}}-v^w_{b_k}+g^w\triangle{t_k})  ]_\times \delta{\theta^w_{b_k}}}{\delta{\theta^w_{b_k}}}
$$

$$
=[R^{b_k}_w(v^w_{b_{k+1}}-v^w_{b_k}+g^w\triangle{t_k})]_\times \tag{15}
$$

再推导第二行：
$$
\frac{\partial{\delta{\theta}^{b_k}_{b_{k+1}}}}{\partial{q^w_{b_k}}}=2\lim_{\delta{\theta^w_{b_k}} \rightarrow 0} \frac{{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes[(q^w_{b_k}\otimes \left |
\begin{matrix}
1 \\
\frac{\delta{\theta^w_{b_k}}}{2}
\end{matrix}
\right |)^{-1}\otimes q^w_{b_{k+1}}] -
{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes[(q^w_{b_k}\otimes \left |
\begin{matrix}
1 \\
0
\end{matrix}
\right |)^{-1}\otimes q^w_{b_{k+1}}]
}{\delta{\theta^w_{b_k}}}
$$

$$
=2\lim_{\delta{\theta^w_{b_k}} \rightarrow 0} \frac{{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes(\left |
\begin{matrix}
1 \\
-\frac{\delta{\theta^w_{b_k}}}{2}
\end{matrix}
\right |\otimes {q^w_{b_k}}^{-1} \otimes q^w_{b_{k+1}}) -
{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes(\left |
\begin{matrix}
1 \\
0
\end{matrix}
\right |\otimes {q^w_{b_k}}^{-1} \otimes q^w_{b_{k+1}})
}{\delta{\theta^w_{b_k}}}
$$

$$
=2\lim_{\delta{\theta^w_{b_k}} \rightarrow 0} \frac{{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes(\left |
\begin{matrix}
1 \\
-\frac{\delta{\theta^w_{b_k}}}{2}
\end{matrix}
\right |\otimes {q^w_{b_k}}^{-1} \otimes q^w_{b_{k+1}}) -
{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes(\left |
\begin{matrix}
1 \\
0
\end{matrix}
\right |\otimes {q^w_{b_k}}^{-1} \otimes q^w_{b_{k+1}})
}{\delta{\theta^w_{b_k}}}
$$

$$
=2\lim_{\delta{\theta^w_{b_k}} \rightarrow 0} \frac{{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes\left |
\begin{matrix}
1 \\
-\frac{\delta{\theta^w_{b_k}}}{2}
\end{matrix}
\right |\otimes  {q^w_{b_k}}^{-1} \otimes q^w_{b_{k+1}}
}{\delta{\theta^w_{b_k}}}
$$

根据《四元数数学基础》式（15）（16）交换律和分配律可得：
$$
=2\lim_{\delta{\theta^w_{b_k}} \rightarrow 0} \frac{
{\mathcal{R}[{q^w_{b_k}}^{-1} \otimes q^w_{b_{k+1}}]
\mathcal{L}[\gamma^{b_k}_{b_{k+1}}}^{-1}]
\left |
\begin{matrix}
1 \\
-\frac{\delta{\theta^w_{b_k}}}{2}
\end{matrix}
\right |}
{\delta{\theta^w_{b_k}}} \tag{16}
$$
下面推导一个性质，令$q=[x, y, z, s]=[w,s]$，根据《四元数数学基础》式（19）可得：
$$
\mathcal{R}(q)=
\left |
\begin{matrix}
 0 & -w^T \\
 w & -[w]_\times
\end{matrix}
\right | + sI_{4\times4}
$$

$$
\mathcal{L}(q)=
\left |
\begin{matrix}
 0 & -w^T \\
 w & [w]_\times
\end{matrix}
\right | + sI_{4\times4}  \tag{17}
$$

如果只有右下角$3\times3$虚部部分，则有：
$$
\mathcal{R}(q^{-1})_{3\times3}=sI_{3\times3}+[w]_\times=\mathcal{L}(q)_{3\times3} \tag{18}
$$
将式（18）代入式（16）可得：
$$
=2\lim_{\delta{\theta^w_{b_k}} \rightarrow 0} \frac{
\{ {\mathcal{L}[{q^w_{b_{k+1}}}^{-1} \otimes q^w_{b_k}  ]
\mathcal{R}[\gamma^{b_k}_{b_{k+1}}}]
\left |
\begin{matrix}
1 \\
-\frac{\delta{\theta^w_{b_k}}}{2}
\end{matrix}
\right | \}_{3\times3}}
{\delta{\theta^w_{b_k}}}
$$

$$
=-{\mathcal{L}[{q^w_{b_{k+1}}}^{-1} \otimes q^w_{b_k}]
\mathcal{R}[\gamma^{b_k}_{b_{k+1}}}] \tag{19}
$$

#### 3.3.2 残差关于$[v^w_{b_k},b_{a_k},b_{w_k}]$的雅各比

$$
J[1]^{15\times9}=[\frac{\partial{r_\mathcal{B}}}{\partial{v^w_{b_k}}},\frac{\partial{r_\mathcal{B}}}{\partial{b_{a_k}}},\frac{\partial{r_\mathcal{B}}}{\partial{b_{w_k}}}]=
\left |
\begin{matrix}
-R^{b_k}_w\triangle{t_k} & -J^{\alpha}_{b_a}  & -J^{\alpha}_{b_w} \\
0          & 0  & -
\mathcal{L}[{q^w_{b_{k+1}}}^{-1}\otimes q^w_{b_k} \otimes \gamma^{b_k}_{b_{k+1}}]_{3\times3}J^{\gamma}_{b_w} \\
-R^{b_k}_w & -J^{\beta}_{b_a}  & -J^{\beta}_{b_w} \\
0          & -I  & 0 \\
0          & 0  & -I
\end{matrix}
\right | \tag{20}
$$

其中$\frac{\partial{r_\mathcal{B}}}{\partial{b_{a_k}}},\frac{\partial{r_\mathcal{B}}}{\partial{b_{w_k}}}$可根据《IMU预积分》中式（20）推导出残差关于bias雅各比的多数项，这里推导下$\frac{\partial{r_\mathcal{B}}}{\partial{b_{w_k}}}$的第二行：
$$
\frac{\partial{\delta{\theta}^{b_k}_{b_{k+1}}}}{\partial{b_{w_k}}}=2\lim_{
\delta{b_{w_k}}\rightarrow 0} \frac{(\gamma^{b_k}_{b_{k+1}}\otimes\left |
\begin{matrix}
1 \\
\frac{1}{2}J^{\gamma}_{b_w}\delta{b_{w_k}}
\end{matrix}
\right |)^{-1}\otimes({q^w_{b_k}}^{-1}\otimes q^w_{b_{k+1}}) -
(\gamma^{b_k}_{b_{k+1}}\otimes\left |
\begin{matrix}
1 \\
0
\end{matrix}
\right |)^{-1}\otimes({q^w_{b_k}}^{-1}\otimes q^w_{b_{k+1}})}
{\delta{b_{w_k}}}
$$

$$
=2\lim_{
\delta{b_{w_k}}\rightarrow 0} \frac{
\left |
\begin{matrix}
0 \\
-\frac{1}{2}J^{\gamma}_{b_w}\delta{b_{w_k}}
\end{matrix}
\right | \otimes
{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes({q^w_{b_k}}^{-1}\otimes q^w_{b_{k+1}})}
{\delta{b_{w_k}}}
$$

$$
=2\lim_{
\delta{b_{w_k}}\rightarrow 0} \frac{
\mathcal{R}[{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes({q^w_{b_k}}^{-1}\otimes q^w_{b_{k+1}})]
\left |
\begin{matrix}
0 \\
-\frac{1}{2}J^{\gamma}_{b_w}\delta{b_{w_k}}
\end{matrix}
\right | 
}
{\delta{b_{w_k}}}
$$

$$
=2\lim_{
\delta{b_{w_k}}\rightarrow 0} \frac{
\mathcal{R}[{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes({q^w_{b_k}}^{-1}\otimes q^w_{b_{k+1}})]
\left |
\begin{matrix}
0 \\
-\frac{1}{2}J^{\gamma}_{b_w}\delta{b_{w_k}}
\end{matrix}
\right | 
}
{\delta{b_{w_k}}}
$$

又根据式（18）化简：
$$
=2\lim_{
\delta{b_{w_k}}\rightarrow 0} 
\frac{ \{
\mathcal{L}[{q^w_{b_{k+1}}}^{-1}\otimes q^w_{b_k} \otimes \gamma^{b_k}_{b_{k+1}}]
\left |
\begin{matrix}
0 \\
-\frac{1}{2}J^{\gamma}_{b_w}\delta{b_{w_k}}
\end{matrix}
\right | \}_{3\times3}
}
{\delta{b_{w_k}}}
$$

$$
=\lim_{
\delta{b_{w_k}}\rightarrow 0} 
\frac{ \{-
\mathcal{L}[{q^w_{b_{k+1}}}^{-1}\otimes q^w_{b_k} \otimes \gamma^{b_k}_{b_{k+1}}]
\left |
\begin{matrix}
0 \\
J^{\gamma}_{b_w}
\end{matrix}
\right | \}_{3\times3} \delta{b_{w_k}}
}
{\delta{b_{w_k}}}
$$

$$
=-
\mathcal{L}[{q^w_{b_{k+1}}}^{-1}\otimes q^w_{b_k} \otimes \gamma^{b_k}_{b_{k+1}}]_{3\times3}J^{\gamma}_{b_w} \tag{21}
$$

#### 3.3.3 残差关于$[p^w_{b_{k+1}},q^w_{b_{k+1}}]$的雅各比

$$
J[2]^{15\times7}=[\frac{\partial{r_\mathcal{B}}}{\partial{p^w_{b_{k+1}}}},\frac{\partial{r_\mathcal{B}}}{\partial{q^w_{b_{k+1}}}}]=
\left |
\begin{matrix}
R^{b_k}_w & 0 \\
0          & \mathcal{L}[{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes{q^w_{b_k}}^{-1}\otimes q^w_{b_{k+1}}]  \\
0          & 0 \\
0          & 0 \\
0          & 0
\end{matrix}
\right | \tag{22}
$$

这里推导下$\frac{\partial{r_\mathcal{B}}}{\partial{q^w_{b_{k+1}}}}$第二行：
$$
\frac{\partial{\delta{\theta}^{b_k}_{b_{k+1}}}}{\partial{q^w_{b_k}}}=2\lim_{\delta{\theta^w_{b_k}} \rightarrow 0} \frac{{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes[{q^w_{b_k}}^{-1}\otimes （q^w_{b_{k+1}} \otimes \left |
\begin{matrix}
1 \\
\frac{\delta{\theta^w_{b_k}}}{2}
\end{matrix}
\right |）] -
{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes[{q^w_{b_k}}^{-1}\otimes （q^w_{b_{k+1}} \otimes \left |
\begin{matrix}
1 \\
0
\end{matrix}
\right |）]
}{\delta{\theta^w_{b_k}}}
$$

$$
=2\lim_{\delta{\theta^w_{b_k}} \rightarrow 0} \frac{{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes[{q^w_{b_k}}^{-1}\otimes （q^w_{b_{k+1}} \otimes \left |
\begin{matrix}
1 \\
\frac{\delta{\theta^w_{b_k}}}{2}
\end{matrix}
\right |）] -
{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes[{q^w_{b_k}}^{-1}\otimes （q^w_{b_{k+1}} \otimes \left |
\begin{matrix}
1 \\
0
\end{matrix}
\right |）]
}{\delta{\theta^w_{b_k}}}
$$

$$
=2\lim_{\delta{\theta^w_{b_k}} \rightarrow 0} \frac{{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes{q^w_{b_k}}^{-1}\otimes q^w_{b_{k+1}} \otimes (\left |
\begin{matrix}
1 \\
\frac{\delta{\theta^w_{b_k}}}{2}
\end{matrix}
\right | - 
 \left |
\begin{matrix}
1 \\
0
\end{matrix}
\right |)

}{\delta{\theta^w_{b_k}}}
$$

$$
=\lim_{\delta{\theta^w_{b_k}} \rightarrow 0} \frac{
\mathcal{L}[{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes{q^w_{b_k}}^{-1}\otimes q^w_{b_{k+1}}]  \left |
\begin{matrix}
0 \\
\delta{\theta^w_{b_k}}
\end{matrix}
\right | 

}{\delta{\theta^w_{b_k}}}
$$

$$
=\mathcal{L}[{\gamma^{b_k}_{b_{k+1}}}^{-1}\otimes{q^w_{b_k}}^{-1}\otimes q^w_{b_{k+1}}]  \tag{23}
$$

#### 3.3.4 残差关于$[v^w_{b_{k+1}},b_{a_{k+1}},b_{w_{k+1}}]$的雅各比

$$
J[3]^{15\times9}=[\frac{\partial{r_\mathcal{B}}}{\partial{v^w_{b_{k+1}}}},\frac{\partial{r_\mathcal{B}}}{\partial{b_{a_{k+1}}}},\frac{\partial{r_\mathcal{B}}}{\partial{b_{w_{k+1}}}}]=
\left |
\begin{matrix}
0 & 0  & 0 \\
0 & 0  & 0 \\
R^{b_k}_w & 0  & 0 \\
0          & I  & 0 \\
0          & 0  & I
\end{matrix}
\right | \tag{24}
$$

## 4 视觉约束

### 4.1 残差

这里的视觉测量残差定义在一个单位球面上而不是传统的成像平面上。考虑第$l$个路标点，第一次在第$i$帧图像被观测到，现在在第$j$帧也观测到后，可定义视觉测量残差为：
$$
r_\mathcal{C}(\hat{z}^{c_j}_l,\mathcal{X})_{2\times1}=\left |
\begin{matrix}
b_1 \\
b_2
\end{matrix}
\right |_{2\times3} (\frac{P^{c_j}_l}{\parallel{P^{c_j}_l}\parallel}-\hat{P}^{c_j}_l)_{3\times1} \tag{25}
$$
其中，
$$
\hat{P}^{c_j}_l={\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_j}_l \\
\hat{v}^{c_j}_l 
\end{matrix}
\right |) \tag{26}
$$

$$
P^{c_j}_l=R^c_b\{R^{b_j}_w[R^w_{b_i}(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\} \tag{27}
$$

$\pi_c$是相机的内参矩阵。$\hat{P}^{c_j}_l$是在第$j$帧相机观测到第$l$个路标点的坐标，$P^{c_j}_l$是通过将路标点的第一次被观测到的第$i$帧相机坐标系转换到第$j$帧相机坐标系，预测其在单位球上的坐标，$b_1$$b_2$是正切平面上任意的正交基。

![1561296346352](/home/max/.config/Typora/typora-user-images/1561296346352.png)

这里推导下式（27）:

第$l$个路标点$P^w_l$在第$i$帧相机下的图像坐标为：
$$
p^{c_i}_{uv}=\lambda_l\pi_c(T^c_bT^{b_i}_wP^w_l)  \tag{28}
$$
其中$\lambda_l$为第$l$路标点在第$i$帧相机中第一次被观测到的逆深度。由此可以得到路标点的世界坐标为：
$$
P^{c_j}_l=R^c_b\{R^{b_j}_w[R^w_{b_i}(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\} \tag{29}
$$
第$l$个路标点$P^w_l$在第$j$帧相机下的坐标为（注意这里不求图像坐标）：
$$
P^{c_j}_l=T^c_bT^{b_j}_wP^w_l \tag{30}
$$
由此同样可得到路标点的世界坐标为：
$$
P^w_l=R^w_{b_j}(R^b_cP^{c_j}_l+p^b_c)+p^w_{b_j} \tag{31}
$$
因此式（29）（31）相等：


$$
R^w_{b_j}(R^b_cP^{c_j}_l+p^b_c)+p^w_{b_j}=R^w_{b_i}(R^b_c(\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |))+p^b_c))+p^w_{b_i}
$$

$$
P^{c_j}_l=R^c_b\{R^{b_j}_w[R^w_{b_i}(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\} \tag{32}
$$

### 4.2 优化变量

优化变量包括第$i$,$j$两帧相机的位姿，IMU和相机之间的外参，路标点的逆深度：
$$
[p^w_{b_i},q^w_{b_i}],[p^w_{b_{i+1}},q^w_{b_{i+1}}],[p^c_b,q^c_b],\lambda_l \tag{33}
$$

### 4.3 雅各比

#### 4.3.1 残差关于$[p^w_{b_i},q^w_{b_i}]$的雅各比

$$
J[0]^{2\times7}=[\frac{\partial{r_\mathcal{C}}}{\partial{p^w_{b_i}}},\frac{\partial{r_\mathcal{C}}}{\partial{q^w_{b_i}}}]=
\left |
\begin{matrix}
R^c_b R^{b_j}_w   & -R^c_bR^{b_j}_w[R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)]_\times \\
0          & 0
\end{matrix}
\right | \tag{34}
$$

这里推导一下$\frac{\partial{r_\mathcal{C}}}{\partial{q^w_{b_i}}}$第一行：
$$
\frac{\partial{r_\mathcal{C}}}{\partial{q^w_{b_i}}}=\lim_{\delta{\theta}^w_{b_i}\rightarrow0}
\frac{R^c_b\{R^{b_j}_w[R^w_{b_i}\exp([\delta{\theta}^w_{b_i}]_\times)(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}}
{\delta{\theta}^w_{b_i}}
$$

$$
=\lim_{\delta{\theta}^w_{b_i}\rightarrow0}
\frac{R^c_b\{R^{b_j}_w[R^w_{b_i}(I+[\delta{\theta}^w_{b_i}]_\times)(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}}
{\delta{\theta}^w_{b_i}}
$$

$$
=\lim_{\delta{\theta}^w_{b_i}\rightarrow0}
\frac{R^c_b\{R^{b_j}_w[R^w_{b_i}[\delta{\theta}^w_{b_i}]_\times(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}}
{\delta{\theta}^w_{b_i}}
$$

$$
=\lim_{\delta{\theta}^w_{b_i}\rightarrow0}
\frac{R^c_b\{R^{b_j}_w[-R^w_{b_i}[R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)]_\times\delta{\theta}^w_{b_i}+p^w_{b_i}-p^w_{b_j}]-p^b_c\}}
{\delta{\theta}^w_{b_i}}
$$

$$
=-R^c_bR^{b_j}_w[R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)]_\times \tag{35}
$$

#### 4.3.2 残差关于$[p^w_{b_{i+1}},q^w_{b_{i+1}}]$的雅各比

$$
J[1]^{2\times7}=[\frac{\partial{r_\mathcal{C}}}{\partial{p^w_{b_{i+1}}}},\frac{\partial{r_\mathcal{C}}}{\partial{q^w_{b_{i+1}}}}]=
\left |
\begin{matrix}
-R^c_b R^{b_j}_w   & R^c_b\{[R^{b_j}_w [R^w_{b_i}(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]]_\times \} \\
0          & 0
\end{matrix}
\right | \tag{36}
$$

这里推导一下$\frac{\partial{r_\mathcal{C}}}{\partial{q^w_{b_{i+1}}}}$第一行：
$$
\frac{\partial{r_\mathcal{C}}}{\partial{q^w_{b_{i+1}}}}=\lim_{\delta{\theta}^w_{b_i}\rightarrow0}
\frac{R^c_b\{[R^w_{b_j}\exp([\delta{\theta}^w_{b_j}]_\times)]^{-1}[R^w_{b_i}(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}}
{\delta{\theta}^w_{b_j}}
$$

$$
=\lim_{\delta{\theta}^w_{b_i}\rightarrow0}
\frac{R^c_b\{(I-[\delta{\theta}^w_{b_j}]_\times) R^{b_j}_w [R^w_{b_i}(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}}
{\delta{\theta}^w_{b_j}}
$$

$$
=\lim_{\delta{\theta}^w_{b_i}\rightarrow0}
\frac{-R^c_b\{[\delta{\theta}^w_{b_j}]_\times R^{b_j}_w [R^w_{b_i}(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}}
{\delta{\theta}^w_{b_j}}
$$

$$
=\lim_{\delta{\theta}^w_{b_i}\rightarrow0}
\frac{R^c_b\{[R^{b_j}_w [R^w_{b_i}(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]]_\times\delta{\theta}^w_{b_j}-p^b_c\}}
{\delta{\theta}^w_{b_j}}
$$

$$
=R^c_b\{[R^{b_j}_w [R^w_{b_i}(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]]_\times \} \tag{37}
$$

#### 4.3.3 残差关于$[p^c_b,q^c_b]$的雅各比

$$
J[2]^{2\times7}=[\frac{\partial{r_\mathcal{C}}}{\partial{p^b_c}},\frac{\partial{r_\mathcal{C}}}{\partial{q^b_c}}]=
\left |
\begin{matrix}
R^c_b(R^{b_j}_wR^w_{b_i}-I)   & -R^c_b R^{b_j}_wR^w_{b_i}R^b_c [\frac{\hat{P}^{c_j}_l}{\lambda_l}]_\times +[R^c_b \{R^{b_j}_w[R^w_{b_i}(R^b_c\frac{\hat{P}^{c_j}_l}{\lambda_l}+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}]_\times  \\
0   & 0
\end{matrix}
\right | \tag{38}
$$

这里推导一下$\frac{\partial{r_\mathcal{C}}}{\partial{q^b_c}}$第一行：
$$
\frac{\partial{r_\mathcal{C}}}{\partial{q^b_c}}=\lim_{\delta{\theta}^w_{b_i}\rightarrow0}
\frac{[R^b_c\exp([\delta{\theta}^b_c]_\times)]^{-1} \{R^{b_j}_w[R^w_{b_i}(R^b_c\exp([\delta{\theta}^b_c]_\times)\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}}
{\delta{\theta}^b_c}
$$

$$
=\lim_{\delta{\theta}^w_{b_i}\rightarrow0}
\frac{(I-[\delta{\theta}]_\times)R^c_b \{R^{b_j}_w[R^w_{b_i}(R^b_c\exp([\delta{\theta}^b_c]_\times)\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}}
{\delta{\theta}^b_c}
$$

$$
=\lim_{\delta{\theta}^w_{b_i}\rightarrow0}
\frac{(I-[\delta{\theta}^b_c]_\times)R^c_b \{R^{b_j}_w[R^w_{b_i}(R^b_c(I+[\delta{\theta}^b_c]_\times)\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}}
{\delta{\theta}^b_c}  \tag{39}
$$

将上式分子化简：
$$
=R^c_b \{R^{b_j}_w[R^w_{b_i}(R^b_c(I+[\delta{\theta}^b_c]_\times)\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}
$$

$$
-[\delta{\theta}^b_c]_\times R^c_b \{R^{b_j}_w[R^w_{b_i}(R^b_c(I+[\delta{\theta}^b_c]_\times)\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}
$$

整理出含$\delta{\theta}^b_c$的项：
$$
=R^c_b \{R^{b_j}_w[R^w_{b_i}(R^b_c [\delta{\theta}^b_c]_\times\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}
$$

$$
-[\delta{\theta}^b_c]_\times R^c_b \{R^{b_j}_w[R^w_{b_i}(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}
$$

$$
-[\delta{\theta}^b_c]_\times R^c_b \{R^{b_j}_w[R^w_{b_i}(R^b_c[\delta{\theta}^b_c]_\times\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}
$$

省略掉第三项：
$$
\approx R^c_b \{R^{b_j}_w[R^w_{b_i}(R^b_c [\delta{\theta}^b_c]_\times\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}
$$

$$
-[\delta{\theta}^b_c]_\times R^c_b \{R^{b_j}_w[R^w_{b_i}(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}
$$

继续整理出含$\delta{\theta}^b_c$的项：
$$
= R^c_b R^{b_j}_wR^w_{b_i}R^b_c [\delta{\theta}^b_c]_\times\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)
$$

$$
+[R^c_b \{R^{b_j}_w[R^w_{b_i}(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}]_\times   \delta{\theta}^b_c
$$

继续化简：
$$
=-R^c_b R^{b_j}_wR^w_{b_i}R^b_c [\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)]_\times \delta{\theta}^b_c
$$

$$
+[R^c_b \{R^{b_j}_w[R^w_{b_i}(R^b_c\frac{1}{\lambda_l}{\pi_c}^{-1}(\left|
\begin{matrix}
\hat{u}^{c_i}_l \\
\hat{v}^{c_i}_l 
\end{matrix}
\right |)+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}]_\times   \delta{\theta}^b_c
$$

将式（26）代入上式可得：
$$
=-R^c_b R^{b_j}_wR^w_{b_i}R^b_c [\frac{\hat{P}^{c_j}_l}{\lambda_l}]_\times \delta{\theta}^b_c
$$

$$
+[R^c_b \{R^{b_j}_w[R^w_{b_i}(R^b_c\frac{\hat{P}^{c_j}_l}{\lambda_l}+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}]_\times   \delta{\theta}^b_c  \tag{40}
$$

将上式（40）代入式（39）可得：
$$
\frac{\partial{r_\mathcal{C}}}{\partial{q^b_c}}=-R^c_b R^{b_j}_wR^w_{b_i}R^b_c [\frac{\hat{P}^{c_j}_l}{\lambda_l}]_\times +[R^c_b \{R^{b_j}_w[R^w_{b_i}(R^b_c\frac{\hat{P}^{c_j}_l}{\lambda_l}+p^b_c)+p^w_{b_i}-p^w_{b_j}]-p^b_c\}]_\times      \tag{41}
$$
